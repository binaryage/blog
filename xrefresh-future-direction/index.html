<!DOCTYPE html>
<html lang="en" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://developers.facebook.com/schema/" class="ba xrefresh-future-direction">
  <head>
    <title>Future direction of XRefresh</title>
    <link rel="canonical" href="http://blog.binaryage.com/xrefresh-future-direction"/>
    <link rel="shortcut icon" href="http://static.binaryage.com/5604bda0_favicon.ico" type="image/x-icon"/>
    <link rel="icon" href="http://static.binaryage.com/5604bda0_favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="http://static.binaryage.com/f915472e_shared_css_site.css" type="text/css"/>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="title" content="Future direction of XRefresh"/>
    <meta name="description" content="Sharing ideas about software, products and cool stuff from BinaryAge"/>
    <meta name="keywords" content="blog,ideas,binaryage,productivity,software,web,development"/>
    <link rel="image_src" href="http://www.binaryage.com/shared/img/icons/binaryage-badge-256.png"/>
    <meta name="google-site-verification" content="N_xzdr6ymSUQFhAEvQg7f-sp1JAeJCdW2JuaRg-da0w"/>
    <meta property="fb:admins" content="antonin.hildebrand"/>
    <link href="http://feeds.feedburner.com/binaryage-blog" type="application/atom+xml" rel="alternate" title="Ideas from BinaryAge"/>
    <script type="text/javascript" charset="utf-8">function parseUri(r){var e=parseUri.options,o=e.parser[e.strictMode?"strict":"loose"].exec(r),s={},t=14;while(t--)s[e.key[t]]=o[t]||"";s[e.q.name]={};s[e.key[12]].replace(e.q.parser,function(r,o,t){if(o)s[e.q.name][o]=t});return s}parseUri.options={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}}</script>
    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
    <script>WebFont.load({google:{families:["Play:400,700:latin"]}})</script>
    <script src="http://static.binaryage.com/cd89ca2f_shared_js_code.js"></script>
    <script type="text/javascript">window["ga"]=function(){}</script>
    <script>window["ga"]=undefined;(function(e,n,a,t,i,o,r){e["GoogleAnalyticsObject"]=i;e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date;o=n.createElement(a),r=n.getElementsByTagName(a)[0];o.async=1;o.src=t;r.parentNode.insertBefore(o,r)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-8404259-1","auto",{allowLinker:true});ga("send","pageview");ga("require","linker");ga("linker:autoLink",["fastspring.com"],true)</script>
  </head>
  <body id="page-blog-xrefresh-future-direction">
    <div id="header">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="relativize">
              <a href="http://www.binaryage.com" title="BinaryAge Software">
                <div class="binaryage-logo">
                  <svg class="logo">
                    <g class="logo-badge">
                      <rect class="logo-badge-background" x="0" y="0" rx="4" ry="4" width="60" height="54"/>
                      <path class="logo-letter-b" d=" M6,47 L6,17 12,17 12,25 29,25 29,47 Z M12,42 L12,30 23,30 23,42 Z"/>
                      <path class="logo-letter-a" d=" M32,47 L32,34 49,34 49,30 32,30 32,25 54,25 54,47 Z M37,42 L37,39 49,39 49,42 Z"/>
                    </g>
                    <g class="logo-label" transform="translate(71, 22)">
                      <g class="logo-word-binary">
                        <path class="logo-label-letter-b" transform="translate(0, 0)" d=" M0,25 L0,0 5,0 5,7 20,7 20,25 Z M5,21 L5,11 15,11 15,21 Z"/>
                        <path class="logo-label-letter-i" transform="translate(22, 0)" d=" M0,25 L0,7 5,7 5,25 Z M0,3 L5,3 5,0 0,0 Z"/>
                        <path class="logo-label-letter-n" transform="translate(29, 0)" d=" M0,25 L0,7 20,7 20,25 15,25 15,11 5,11 5,25 Z"/>
                        <path class="logo-label-letter-a" transform="translate(51, 0)" d=" M0,25 L0,14 15,14 15,11 0,11 0,7 20,7 20,25 Z M5,21 L5,18 15,18 15,21 Z"/>
                        <path class="logo-label-letter-r" transform="translate(73, 0)" d=" M0,25 L0,7 20,7 20,11 5,11 5,25 Z"/>
                        <path class="logo-label-letter-y" transform="translate(95, 0)" d=" M0,25 L0,7 5,7 5,21 15,21 15,7 20,7 20,32 0,32 0,28 15,28 15,25 Z"/>
                      </g>
                      <g class="logo-word-age" transform="translate(118, 0)">
                        <path class="logo-label-letter-a" transform="translate(0, 0)" d=" M0,25 L0,14 15,14 15,11 0,11 0,7 20,7 20,25 Z M5,21 L5,18 15,18 15,21 Z"/>
                        <path class="logo-label-letter-g" transform="translate(22, 0)" d=" M0,25 L0,7 20,7 20,32 0,32 0,28 15,28 15,25 Z M5,21 L5,11 15,11 15,21 Z"/>
                        <path class="logo-label-letter-e" transform="translate(44, 0)" d=" M0,25 L0,7 20,7 20,18 5,18 5,21 20,21 20,25 Z M5,14 L5,11 15,11 15,14 Z"/>
                      </g>
                    </g>
                  </svg>
                </div>
              </a>
            </div>
            <div class="relativize">
              <ul class="header-menu menu-selected-blog">
                <li class="menu-item-store"><a href="http://www.binaryage.com/store"><i class="fa fa-shopping-cart"></i><span>store</span></a></li>
                <li class="menu-item-products"><a href="http://www.binaryage.com"><i class="fa fa-star"></i><span>products</span></a></li>
                <li class="menu-item-blog"><a href="http://blog.binaryage.com"><i class="fa fa-bullhorn"></i><span>blog</span></a></li>
                <li class="menu-item-support"><a href="http://discuss.binaryage.com"><i class="fa fa-comments"></i><span>support</span></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="main" class="cf">
      <div id="blog">
        <div class="container">
          <div class="row">
            <div class="col-md-9">
              <div class="blog-content">
                <div class="row">
                  <div class="col-md-2">
                    <div class="blog-leftbar">
                      <a class="back-button" href="/">Â« back to articles</a>
                    </div>
                    <div class="content-leftbar">
                      <div class="article-info">
                        <span class="article-posted">published</span>
                        <span class="article-date">on November 15, 2009</span>
                        <span class="article-author">by <a href="http://hildebrand.cz">Antonin Hildebrand</a></span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-10">
                    <div id="post">
                      <div class="post-titlebar">
                        <span class="post-title">Future direction of XRefresh</span>
                      </div>
                      <div class="generic-separator"></div>
                      <div class="post-content">
                        <p><img src="http://static.binaryage.com/08b556aa_shared_img_icons_xrefresh-128.png" class="intro-icon"/></p>
                        <p><strong><a href="http://xrefresh.binaryage.com">XRefresh</a> is a simple tool which is able to refresh a web page in the browser in reaction to a file modification.</strong></p>
                        <h4>Here is the problem</h4>
                        <blockquote><p>I want to prototype HTML and CSS changes on live page (Firebug), but I don't want to manually sync the changes back to my original sources.</p></blockquote>
                        <p>XRefresh is especially useful on dual monitor system. You can stay in your favorite editor and as you type it will preview the page automatically on a secondary monitor in open browser window.</p>
                        <h4>The implementation</h4>
                        <p>XRefresh is implemented as a browser extension and a filesystem monitor. These two components talk to each other using TCP connection. Whenever something changes, the monitor notifies the extension which then instructs the browser to do a full refresh of the page.</p>
                        <p>This solution has some advantages:</p>
                        <ul>
                          <li>it is independent of the text editor or IDE you are using for web development</li>
                          <li>is is independent of the server-side stack (you can run locally any server technology you want)</li>
                          <li>it is possible to use XRefresh over a network (in case you are editing files on a remote box)</li>
                        </ul>
                        <p>Full page refresh is a robust solution and works pretty well for simple static pages, but it has one big drawback for dynamic pages. After refresh you usually lose state of the web application. Let's say you have AJAX application, which has some dynamic UI. Say, a HTML dialog opened after clicking on a button. For prototyping such an UI you have to first click through application to get into the required state. But XRefresh does a full refresh which forces you to this again and again after every tiny change to a file. This destroys the original productivity workflow. As I was doing more and more complex pages I was thinking how to solve this problem...</p>
                        <p>The first idea was to use some kind of macro recorder and replay user actions after every refresh automatically. This seemed as a pretty general solution in theory but didn't work in reality. In Firefox I tried to implement simple listener for user events like mouse clicks and key strokes and then tried to replay them on top of new page. This approach had terrible timing issues and also failed because not all events were 100% reproducible. Some products like iMacros, Selenium or other tools are trying to implement something like that. Maybe they have found some way how to do it well, but from this experience I doubt it is a robust solution in more complex cases.</p>
                        <p>The second idea was to solve this just for CSS prototyping. In case the page uses externally linked CSS files, it is easily possible to refresh just external CSS file and let browser do the hard work of updating styles without full refresh. This worked surprisingly well. With TextMate on OSX I was able to get to a Firebug-like CSS prototyping experience. The only drawback is that it puts constraints on XRefresh user: it works only for CSS, you have to reference CSS files externally, no CSS dependencies via @import and you have to keep to a simple URL mapping schema (I'm using fuzzy filename&lt;-&gt;url matcher to decide what CSS references to update).</p>
                        <h4>But what about live HTML update?</h4>
                        <p>This is still an open problem and much harder. I'm thinking about a solution for this. It is not robust but I believe it should be useful for 99% of cases (at least when user learns safe editing patterns).</p>
                        <p>The idea is to have some kind of smart diff algorithm. Whenever file changes don't do a full refresh, but instead reload just affected HTML file into the browser in the background. Because we know the original HTML source and the new HTML source we can do a diff of these. This way we can identify modified chunks. With the knowledge of HTML parsing we can extend these chunks into some kind of "address plus modification descriptor". Address can be selector, xpath or something like anchoring regexp. Modification is something like "replace aaa with bbb" or "insert xxx after yyy" or even "set innerHTML of addressed node" in case the change went across HTML node boundaries. In javascript we can then implement updater function which is able to consume these patches and apply them to live DOM.</p>
                        <p>Of course, this is far from a robust solution. But we don't need a robust one, we need <strong>good enough solution</strong>(tm). Smart diff encoding which maps well on DOM is one important task. The other difficult problem is having these changes not interfere with dynamic page functionality. As you can see obvious complication is event handlers attached to existing DOM nodes. Less obvious is javascript expando properties on DOM nodes: with replacing whole DOM subtrees we are going to lose them. But this may be not as bad as it seems. The updater can be smart enough to reuse existing nodes whenever possible. Or Firefox 3.6 has a new API for iterating event handlers on nodes. Theoretically we can collect important expando javascript properties and event handlers and re-apply them on new nodes. Yeah, sounds like a lot of troubles and there are probably more problems I quite don't see right now. But the problem is really challenging (at least for me).</p>
                        <p>I'm thinking about a proof-of-concept project where we can test this idea.</p>
                        <h4>The idea</h4>
                        <p><strong>Create a web-based editor for HTML and CSS with live-update feature</strong></p>
                        <ul>
                          <li>Create a bookmarklet which enables user to inject 'updater.js' javascript file into any HTML page.</li>
                          <li>Implement updater.js
                            <ul>
                              <li>it opens a new browser window and embeds there Bespin code editor (they released standalone embeddable version a few days ago), put parent page's HTML in there</li>
                              <li>it implements protocol for incrementally changing live page by accepting and applying
                                <ul>
                                  <li>CSS "patches"</li>
                                  <li>HTML "patches"</li>
                                </ul>
                              </li>
                            </ul>
                          </li>
                          <li>In the code window implement watcher.js, which watches changes in the code editor, continuously making diffs and translating them into a series of patches (if applicable)</li>
                          <li>Implement simple communication channel between parent window and code window (as simple as window.opener.update(jsonMessage) ).
                          Wire watcher.js to send messages to updater.js.</li>
                        </ul>
                        <h4>The challenging parts:</h4>
                        <ul>
                          <li>design protocol for communication between watcher and updater</li>
                          <li>implement smart diff analyzer or maybe full HTML/CSS parser on watcher side</li>
                          <li>implement efficient updater (use DOM APIs for incrementally updating HTML and CSS or some suitable library)</li>
                        </ul>
                        <h4>Keep in mind:</h4>
                        <ul>
                          <li>by "patches" I don't necessarily mean unified patches but rather
                            high-level JSON descriptions of what to change (a good granularity for
                            CSS may be CSS-rules level, for HTML minimal enclosing innerHTML-like
                          snippets addressed by XPaths or CSS selectors?)</li>
                          <li>updater.js should be as simple as possible and not pollute global
                            namespace (imagine inclusion into really messy pages), patching
                            intelligence should be shifted more towards watcher.js side (imagine
                          watcher implementation server-side)</li>
                          <li>the protocol should possibly work well over the network</li>
                        </ul>
                        <h4>Possible applications I see right now:</h4>
                        <ul>
                          <li>the next version of XRefresh of course :-)</li>
                          <li>web-based HTML code editors (there are plenty of them in the wild and to be honest I'm also working on one of them)</li>
                          <li>replacement for Firebug's feature for rewriting pieces of HTML or live Bespin-based CSS editor in Firebug</li>
                          <li>development tool for PhoneGap based mobile applications (watcher sends updates directly into running page in webkit in the iPhone simulator)</li>
                        </ul>
                        <h4>Is this viable?</h4>
                        <p>I'm not going to write such a thing right away. It definitely does not look like a weekend project. I'd like to validate this idea and ideally gather like-minded hackers to evaluate it. What do you think?</p>
                      </div>
                    </div>
                    <div class="generic-separator"></div>
                    <div id="comments">
                      <div id="disqus_thread"></div>
                      <script type="text/javascript">var disqus_shortname="binaryage";var disqus_url="http://blog.binaryage.com/xrefresh-future-direction/";(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script>
                      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    </div>
                  </div>
                </div>
                <script>(function(){$(".blog-image").wrap(function(){return $("<a class='wrapped-blog-image' data-fancybox-group='blog'></div>").attr("href",$(this).attr("src")).attr("title",$(this).attr("title"))});$(".wrapped-blog-image").fancybox()})()</script>
              </div>
            </div>
            <div class="col-md-3">
              <div class="blog-side">
                <div class="blog-side-box blog-side-follow">
                  <a href="http://twitter.com/binaryage" class="twitter-follow-button" data-show-count="true">Follow @binaryage</a>
                  <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
                </div>
                <div class="blog-side-box blog-side-subscribe">
                  <a href="http://feeds.feedburner.com/binaryage-blog" rel="alternate" type="application/rss+xml"><div class="blog-side-icon blog-rss-icon"></div></a>
                  <a href="http://feeds.feedburner.com/binaryage-blog" rel="alternate" type="application/rss+xml">Subscribe</a>
                  <div class="subscribe-button">
                    <a href="http://feeds.feedburner.com/binaryage-blog"><img src="http://feeds.feedburner.com/~fc/binaryage-blog?bg=dddddd&amp;fg=444444&amp;anim=0" height="26" width="88" style="border:0" alt=""/></a>
                  </div>
                </div>
                <div class="blog-side-box blog-side-products">
                  <div class="blog-side-product">
                    <a href="http://totalfinder.binaryage.com">
                      <img src="http://static.binaryage.com/4029a862_shared_img_icons_totalfinder-64.png" width="38" height="38"/>
                      <span class="title">TotalFinder</span>
                      <span class="info">Adds tabs to your Finder.app!</span>
                    </a>
                  </div>
                  <div class="blog-side-product">
                    <a href="http://totalspaces.binaryage.com">
                      <img src="http://static.binaryage.com/52792a5d_shared_img_icons_totalspaces-64.png" width="38" height="38"/>
                      <span class="title">TotalSpaces</span>
                      <span class="info">The ultimate desktop manager</span>
                    </a>
                  </div>
                  <div class="blog-side-product">
                    <a href="http://totalterminal.binaryage.com">
                      <img src="http://static.binaryage.com/55edff29_shared_img_icons_totalterminal-64.png" width="38" height="38"/>
                      <span class="title">TotalTerminal</span>
                      <span class="info">A Quake-style Terminal window</span>
                    </a>
                  </div>
                  <div class="blog-side-product">
                    <a href="http://firequery.binaryage.com">
                      <img src="http://static.binaryage.com/e506cf2d_shared_img_icons_firequery-64.png" width="38" height="38"/>
                      <span class="title">FireQuery</span>
                      <span class="info">jQuery development in Firebug</span>
                    </a>
                  </div>
                  <div class="blog-side-product">
                    <a href="http://firelogger.binaryage.com">
                      <img src="http://static.binaryage.com/dff2e903_shared_img_icons_firelogger-64.png" width="38" height="38"/>
                      <span class="title">FireLogger</span>
                      <span class="info">Realtime logging into Firebug</span>
                    </a>
                  </div>
                  <div class="blog-side-product">
                    <a href="http://firerainbow.binaryage.com">
                      <img src="http://static.binaryage.com/b424aa93_shared_img_icons_firerainbow-64.png" width="38" height="38"/>
                      <span class="title">FireRainbow</span>
                      <span class="info">A syntax highlighting for Firebug</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <p></div></p>
    <div id="footer">
      <div class="container">
        <div class="row">
          <div class="col-md-8">
          </div>
          <div class="col-md-4">
            <div class="footer-box-right">
              <div class="footer-copyright">
                <div class="footer-license">
                  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0"><img title="the website license" alt="Creative Commons License" style="border-width:0" src="http://static.binaryage.com/69a4ba35_shared_img_byccnd.png"/></a>
                </div>
                <a href="http://www.binaryage.com/about">BinaryAge Limited</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" charset="utf-8">if(window.jQuery){$(function(){setTimeout(function(){var i=location.hash.substring(1);if(i.substring(0,2)=="o-"){$("#"+i).trigger("click")}},500)})}</script>
    <script type="text/javascript">var _gauges=_gauges||[];(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.id="gauges-tracker";e.setAttribute("data-site-id","4f10d65d844d52139500000b");e.src="//secure.gaug.es/track.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()</script>
  </body>
</html>